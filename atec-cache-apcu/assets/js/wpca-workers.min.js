(()=>{const outEl=()=>document.getElementById("atec-wpca-workers-out");function log(line=""){const el=outEl();el&&(el.textContent+=line+"\n")}function resetLog(){const el=outEl();el&&(el.textContent="")}async function probeOnce({sleepMs:sleepMs=0}={}){const c=function(){const c=window.ATEC_WPCA_WORKERS||{};if(!c.restUrl||!c.nonce)throw new Error("WPCA: Missing REST config (restUrl/nonce).");return c}(),url=function(urlStr){const u=new URL(urlStr,window.location.origin);return u.searchParams.set("r",String(Math.random())),u.toString()}(c.restUrl),res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":c.nonce},body:JSON.stringify({sleep_ms:sleepMs})});if(!res.ok){const txt=await res.text().catch((()=>""));throw new Error(`HTTP ${res.status} ${res.statusText}: ${txt}`)}return await res.json()}async function runPhase({name:name,total:total,concurrency:concurrency,sleepMs:sleepMs}){log(`${name}: total=${total}, concurrency=${concurrency}, sleepMs=${sleepMs}`);const pidCounts=new Map;let sharedEver=!1,idx=0;async function worker(){for(;idx<total;){const n=idx++,r=await probeOnce({sleepMs:sleepMs}),pid=String(r?.pid??"0");pidCounts.set(pid,(pidCounts.get(pid)||0)+1),r?.shared_apcu_signal&&(sharedEver=!0),(n+1)%Math.max(1,Math.floor(total/10))==0&&log(`…${n+1}/${total}`)}}const workers=[];for(let i=0;i<concurrency;i++)workers.push(worker());await Promise.all(workers);const uniquePids=[...pidCounts.keys()].filter((p=>"0"!==p));return uniquePids.sort(((a,b)=>(pidCounts.get(b)||0)-(pidCounts.get(a)||0))),{name:name,total:total,concurrency:concurrency,sleepMs:sleepMs,pidCounts:pidCounts,uniquePids:uniquePids,sharedEver:sharedEver}}function printSummary(phases){const aggPidCounts=new Map;let sharedEver=!1;for(const ph of phases){sharedEver=sharedEver||ph.sharedEver;for(const[pid,cnt]of ph.pidCounts.entries())aggPidCounts.set(pid,(aggPidCounts.get(pid)||0)+cnt)}const uniquePids=[...aggPidCounts.keys()].filter((p=>"0"!==p));uniquePids.sort(((a,b)=>(aggPidCounts.get(b)||0)-(aggPidCounts.get(a)||0))),log(""),log("Summary"),log("-------"),log(`Unique PIDs observed: ${uniquePids.length}${uniquePids.length?` (${uniquePids.join(", ")})`:""}`),log("APCu shared across processes detected: "+(sharedEver?"YES":"NO")),log(""),log("PID distribution:");for(const pid of uniquePids)log(`  ${pid}: ${aggPidCounts.get(pid)} hits`);log("");const totalRequests=phases.reduce(((s,ph)=>s+ph.total),0),hasOverlap=phases.some((ph=>ph.sleepMs>0));return uniquePids.length>=2&&sharedEver?(log("✅ OC is SAFE: Multiple PHP workers detected and APCu memory is shared across them."),log("   APCu Object Cache should be coherent across requests."),{verdict:"SAFE",uniquePids:uniquePids.length,sharedEver:sharedEver,totalRequests:totalRequests}):uniquePids.length>=2&&!sharedEver&&totalRequests>=20&&hasOverlap?(log("❌ OC is NOT SAFE: Multiple PHP workers detected but APCu memory is NOT shared across them."),log("   APCu Object Cache can be incoherent (different workers may serve different cached values)."),{verdict:"NOT_SAFE",uniquePids:uniquePids.length,sharedEver:sharedEver,totalRequests:totalRequests}):(log("⚠️ Result is INCONCLUSIVE: Not enough evidence to decide."),log("   Reasons: only one PID observed (sticky routing) or too few samples."),log("   Tip: run the overlap test and/or increase total requests."),{verdict:"INCONCLUSIVE",uniquePids:uniquePids.length,sharedEver:sharedEver,totalRequests:totalRequests})}async function runManual(opts){resetLog(),log("Manual test"),log("----------");return printSummary([await runPhase({name:"Phase",...opts})])}function bind(btnId,fn){const btn=document.getElementById(btnId);btn&&btn.addEventListener("click",(async()=>{btn.disabled=!0;try{await fn()}catch(e){resetLog(),log(String(e?.message||e))}finally{btn.disabled=!1}}))}document.addEventListener("DOMContentLoaded",(async()=>{bind("atec-wpca-workers-quick",(()=>runManual({total:20,concurrency:8,sleepMs:0}))),bind("atec-wpca-workers-overlap",(()=>runManual({total:20,concurrency:8,sleepMs:200})));try{await async function(){resetLog(),log("Running automatic workers/APCu probe…"),log("");const phaseA=await runPhase({name:"Phase A (spread)",total:20,concurrency:6,sleepMs:0});return log(""),printSummary([phaseA,await runPhase({name:"Phase B (overlap)",total:12,concurrency:6,sleepMs:200})])}()}catch(e){resetLog(),log(String(e?.message||e))}}))})();